name: CI

on:
  push:
    branches:
      - '**'
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-build.[0-9]+'

jobs:
  unit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2.3.4
    - uses: actions/setup-go@v4.0.0
      with:
        go-version: 1.19.x
    - name: Install tanzu cli
      run: |
        TANZU_VERSION=$(cat TANZU_VERSION)
        curl -L -o tanzu-cli-linux-amd64.tar.gz https://github.com/vmware-tanzu/tanzu-cli/releases/download/${TANZU_VERSION}/tanzu-cli-linux-amd64.tar.gz && \
          mkdir -p tanzu && \
          tar xvzf tanzu-cli-linux-amd64.tar.gz -C tanzu
        sudo install tanzu/${TANZU_VERSION}/tanzu-cli-linux_amd64 /usr/local/bin/tanzu
        tanzu ceip-participation set false
        tanzu init
        tanzu version
        tanzu plugin install builder --version ${TANZU_VERSION} --target global
        tanzu plugin install test --version ${TANZU_VERSION} --target global
        tanzu plugin list
